GSoC’21 Improve performance through the use of Pythran
######################################################

:date: 2021-08-19
:category: examples
:lang: en
:authors: Xingyu Liu
:summary: This project is about using Pythran to accelerate algorithms in SciPy and 
          writing benchmarks for the algorithms. Let's look into the details of the project.



Project Overview
================
There are a lot of algorithms in scipy that use Cython to improve 
the performance of code that would be too slow as pure Python, 
e.g. algorithms in ``scipy.spatial``, ``scipy.stats`` and ``scipy.optimize``, etc. 
Recently, SciPy added experimental support for Pythran, 
to make it easier to accelerate Python code. 
Compared with Cython, Pythran is more readable and even faster. 
Furthermore, SciPy uses Airspeed Velocity for performance benchmarking. 
Therefore, our project includes:


* Accelerating SciPy algorithms with Pythran.
* Writing benchmarks for the algorithms in SciPy
* Find and solve potential issues in Pythran


My full proposal can be accessed `here <https://docs.google.com/document/d/1nM7dYbmModiukQw-sSOVGz6t5S6HC0VVWucYadI_aMQ/edit?usp=sharing>`_.


What I have done
================

**Pull Requests**:

#. [Merged] `BENCH: add benchmark for f_oneway <https://github.com/scipy/scipy/pull/14018>`_
#. [Merged] `BENCH: add benchmark for energy_distance and wasserstein_distance <https://github.com/scipy/scipy/pull/14163>`_
#. [Merged] `BENCH: add more benchmarks for inferential statistics tests <https://github.com/scipy/scipy/pull/14228#>`_
#. [Merged] `MAINT: Modify to use new random API in benchmarks <https://github.com/scipy/scipy/pull/14224#>`_: Most of current benchmarks uses ``np.random.seed()``, but it is recommended to use ``np.random.default_rng()`` instead.
#. [Merged] `ENH: use Pythran to speedup somersd and _tau_b <https://github.com/scipy/scipy/pull/14308>`_
#. [Merged] `Import test cases from scipy <https://github.com/serge-sans-paille/pythran/pull/1830>`_ : Import Pythran functions in SciPy as test case in Pythran
#. [Merged] `BENCH: add benchmark for somersd <https://github.com/scipy/scipy>`_
#. [Merged] `Feature/add keep dims <https://github.com/serge-sans-paille/pythran/pull/1869#>`_ : support keepdims argument in ``np.mean()`` in Pythran
#. [Merged] `Support boolean arguments in numpy unique <https://github.com/serge-sans-paille/pythran/pull/1876>`_
#. [Merged] `General implementation of supporting immediate arguments <https://github.com/serge-sans-paille/pythran/pull/1878>`_: Generalize the above two solutions to support immediate arguments.
#. [Under Review] `ENH: Pythran implementation of _compute_prob_outside_square and _compute_prob_inside_method to speedup stats.ks_2samp <https://github.com/scipy/scipy/pull/13957>`_
#. [Under Review] `BUG: fix stats.binned_statistic_dd issue with values close to bin edge <https://github.com/scipy/scipy/pull/14338>`_
#. [Under Review] `ENH: improved binned_statistic_dd via Pythran <https://github.com/scipy/scipy/pull/14345>`_ 
#. [Under Review] `ENH: improve cspline1d, qspline1d, and relative funcs via Pythran <https://github.com/scipy/scipy/pull/14429>`_ 
#. [Under Review] `ENH: improve siegelslopes via pythran <https://github.com/scipy/scipy/pull/14430>`_ 
#. [Hold] `ENH: Pythran implementation of _cdf_distance <https://github.com/scipy/scipy/pull/14154>`_ : Pythran version is slightly better than the Python one after fixing ``np.searchsorted()``. When SciPy begin using SIMD in the future, it may be faster so this PR is currently on hold.
#. [Hold] `WIP: ENH: improve _count_paths_outside_method via pythran <https://github.com/scipy/scipy/pull/14314>`_ : This PR got stuck in a Mac specific error and we haven’t find out why.
#. [Hold] `WIP: ENH: improve sort_vertices_of_regions via Pythran and made it more readable <https://github.com/scipy/scipy/pull/14376>`_ : There are currently two tests we can’t pass because 1. With Pythran we can’t do inplace sort 2. The input type will change in the Pythran function
#. [Closed] `ENH: improve _sosfilt_float via Pythran <https://github.com/scipy/scipy/pull/14473>`_  : ``_sosfilt_float`` is already implemented in Cython. We were considering to replace it but found Pythran performance is not much better than Cython's, and Pythran does not support ``object`` type, so we decided not to merge it.

Since one of our goals is to find potential issues in Pythran and make Pythran better, I also bring up many issues in Pythran.

**Issues**:

#. [closed] `Pythran makes np.searchsorted much slower <https://github.com/serge-sans-paille/pythran/issues/1793>`_ 
#. [closed] `Pythran may make a function slower? <https://github.com/serge-sans-paille/pythran/issues/1753>`_ 
#. [closed] `u_values[u_sorter].searchsort would cause "Function path is chained attributes and name" but np.search would not <https://github.com/serge-sans-paille/pythran/issues/1792>`_
#. [closed] `all_values.sort() would cause compilation error but np.sort(all_values) would not <https://github.com/serge-sans-paille/pythran/issues/1791>`_
#. [closed] `u_values[u_sorter].searchsort would cause "Function path is chained attributes and name" but np.searchsort would not <https://github.com/serge-sans-paille/pythran/issues/1792>`_
#. [closed] `Support scipy.special.binom? <https://github.com/serge-sans-paille/pythran/issues/1804>`_
#. [closed] `Got AttributeError: module 'scipy' has no attribute 'special' when building scipy with special import <https://github.com/serge-sans-paille/pythran/issues/1815>`_
#. [closed] `Got compilation error when the inner variable type changes <https://github.com/serge-sans-paille/pythran/issues/1818>`_
#. [closed] `Can't index an 2d array like a1[int, tuple] <https://github.com/serge-sans-paille/pythran/issues/1819>`_
#. [closed] `keep_dims is not supported in np.mean() <https://github.com/serge-sans-paille/pythran/issues/1820>`_
#. [closed] `can't use np.expand_dims with specified keyword argument <https://github.com/serge-sans-paille/pythran/issues/1850>`_
#. [open ] `bus error on Mac but works fine on Linux for _count_paths_outside_method pythran version <https://github.com/scipy/scipy/issues/14315>`_ 
#. [open ] `array assignment res[cond1] = ax[cond1] works fine for int[] or float[] or float[:,:] but not int[:,:] <https://github.com/serge-sans-paille/pythran/issues/1858>`_

Work Left
=========

As the project proceeded, I found it was difficult to find 
suitable algorithms to be implemented. Moreover, in our past experience 
with Pythran,  we often run into some things that are easy to get wrong. 
Therefore, we need better testing  and we decided to change the plan to 
write better testing infrastructure for Pythran extensions: 
`WIP: TST: add tests for Pythran somersd <https://github.com/scipy/scipy/pull/14559#>`_


Project Experience
==================
It has been a great experience working on this project in GSoC'21, 
my mentors are really friendly and responsive, 
and the community are also always willing to help. 


Special thanks to my mentors, Ralf and Serge, who provided immense support 
for me to get through the difficulties.
I’m very fortunate to get the chance to dive into and contribute to SciPy 
and Pythran this summer, especially with such awesome mentors. 
I have learnt a lot, intellectual or spiritual, and I would love to continue contributing to SciPy and Pythran in the future :)


Thanks to Google Summer of Code and Python Software Foundation! 

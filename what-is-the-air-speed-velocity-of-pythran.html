<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>What is the air speed velocity of Pythran?</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="serge-sans-paille and other pythraners">

    <!-- Le styles -->
    <link rel="stylesheet" href="./theme/css/bootstrap.min.css" type="text/css" />
    <style type="text/css">
      body {
        padding-top: 60px;
        padding-bottom: 40px;
      }
      .sidebar-nav {
        padding: 9px 0;
      }
      .tag-1 {
        font-size: 13pt;
      }
      .tag-2 {
        font-size: 10pt;
      }
      .tag-2 {
        font-size: 8pt;
      }
      .tag-4 {
        font-size: 6pt;
     }
    </style>
    <link href="./theme/css/bootstrap-responsive.min.css" rel="stylesheet">
        <link href="./theme/css/font-awesome.css" rel="stylesheet">

    <link href="./theme/css/pygments.css" rel="stylesheet">

    <!-- Le HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="//html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!-- Le fav and touch icons -->
    <link rel="shortcut icon" href="./theme/images/favicon.ico">
    <link rel="apple-touch-icon" href="./theme/images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="./theme/images/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="./theme/images/apple-touch-icon-114x114.png">

    <link href="./" type="application/atom+xml" rel="alternate" title="Pythran stories ATOM Feed" />

  </head>

  <body>

    <div class="navbar navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container-fluid">
          <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </a>
          <a class="brand" href="./index.html">Pythran stories </a>
          <div class="nav-collapse">
            <ul class="nav">
                          <li class="divider-vertical"></li>
                  <li class="active">
                    <a href="./category/benchmark.html">
						<i class="icon-folder-open icon-large"></i>benchmark
					</a>
                  </li>
                  <li >
                    <a href="./category/compilation.html">
						<i class="icon-folder-open icon-large"></i>compilation
					</a>
                  </li>
                  <li >
                    <a href="./category/engineering.html">
						<i class="icon-folder-open icon-large"></i>engineering
					</a>
                  </li>
                  <li >
                    <a href="./category/examples.html">
						<i class="icon-folder-open icon-large"></i>examples
					</a>
                  </li>
                  <li >
                    <a href="./category/optimisation.html">
						<i class="icon-folder-open icon-large"></i>optimisation
					</a>
                  </li>
                  <li >
                    <a href="./category/release.html">
						<i class="icon-folder-open icon-large"></i>release
					</a>
                  </li>

                          <ul class="nav pull-right">
                                <li><a href="./archives.html"><i class="icon-th-list"></i>Archives</a></li>
                          </ul>

            </ul>
            <!--<p class="navbar-text pull-right">Logged in as <a href="#">username</a></p>-->
          </div><!--/.nav-collapse -->
        </div>
      </div>
    </div>

    <div class="container-fluid">
      <div class="row">
        <div class="span9" id="content">
<section id="content">
        <article>
                <header>
                        <h1>
                                <a href=""
                                        rel="bookmark"
                                        title="Permalink to What is the air speed velocity of Pythran?">
                                        What is the air speed velocity of Pythran?
                                </a>
                        </h1>
                </header>
                <div class="entry-content">
                <div class="well">
<footer class="post-info">
<span class="label">Date</span>
<abbr class="published" title="2018-08-05T00:00:00+02:00">
        <i class="icon-calendar"></i>Sun 05 August 2018
</abbr>
<span class="label">By</span>
<a href="./author/serge-sans-paille.html"><i class="icon-user"></i>serge-sans-paille</a>
<span class="label">Category</span>
<a href="./category/benchmark.html"><i class="icon-folder-open"></i>benchmark</a>.


</footer><!-- /.post-info -->                </div>
                <p>As many projects, <a class="reference external" href="https://github.com/serge-sans-paille/pythran">Pythran</a> has
its own test suite that runs on <a class="reference external" href="http://travis-ci.org/">travis-ci</a> and
<a class="reference external" href="http://appveyor.com/">AppVeyor</a>. It's a nice test suite: it tests different
compilers—namely Clang, GCC and MVSCC—with different set of flags—with and
without OpenMP and vectorization— and for the 2.7 and 3.5 Python versions.
Nice. Brest.</p>
<p>A while ago, I started to collect various high-level Numpy kernels in the
<a class="reference external" href="https://github.com/serge-sans-paille/numpy-benchmarks/">numpy-benchmark</a>
repo. The goal was to check how well Pythran behaves on these kernels, and to
compare it with other compilers. Over the time I've been adding new kernels
that showcases different optimization challenges, which leads us to more than 35
different kernels. I was occasionally using that set of kernels to check for
performance regression, but that was only semi-automated and rather tedious.</p>
<p>Then comes <a class="reference external" href="https://github.com/airspeed-velocity/asv/">airspeed velocity</a>, a
tool that exactly brings the remaining bits: automated benchmarking over
software revision, regression tracking and nice plots. So it was just a matter
of stirring everything together to give birth to
<a class="reference external" href="https://github.com/serge-sans-paille/pythran-asv">https://github.com/serge-sans-paille/pythran-asv</a>. In order to not break the
link with <em>numpy-benchmarks</em>, the original repo is imported as a <a class="reference external" href="https://github.com/git/git/blob/master/contrib/subtree/git-subtree.txt">git subtree</a>, and
the tests are automatically generated based on the kernel annotations :-)</p>
<div class="section" id="configuration">
<h2>Configuration</h2>
<p>I don't have a dedicated machine to run the performance tracking session, so I just ran the following:</p>
<pre class="code sh literal-block">
$ asv <span class="m">0</span>.8.6..master
</pre>
<p>Basically, this commands runs <tt class="docutils literal">timeit</tt> on all kernels from <em>numpy-benchmarks</em>
according to the kernel annotations, but only once these kernels have been
compiled by the <em>Pythran</em> compiler extracted from the revisions ranging from
latest release, <em>0.8.6</em> to current <em>master</em>. That's a good way to check if the recent
commits brought any performance improvement or regressions.</p>
<p>In order to reduce system glitter, the following one-liner helps a lot:</p>
<pre class="code sh literal-block">
$ python -m perf system tune
</pre>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">These benchmarks were run during the night, with all apps closed, using a
blank <tt class="docutils literal"><span class="pre">~/.pythranrc</span></tt> and GCC 7.3 and on good ol' Python 2.7. For
reference, I have an <tt class="docutils literal">Intel(R) Core(TM) <span class="pre">i7-6600U</span> CPU &#64; 2.60GHz</tt>, but as
the goal is merely to track regression, the details are not as relevant as
they could be for a traditional benchmark setup.</p>
</div>
</div>
<div class="section" id="subtilities">
<h2>Subtilities</h2>
<p>Although <em>asv</em> works like a charm, some aspects require care.</p>
<ol class="arabic simple">
<li><em>Pythran</em> is an ahead of time compiler, so it does not make sense to track
compilation time as part of the actual benchmark. <em>asv</em> does provide a
<tt class="docutils literal">setup</tt> mechanism, but it proved to be too costly (the compilation is
called multiple times, and it costs too much time when ranging over hundreds
of commits). Fortunately, there is a <tt class="docutils literal">setup_cache</tt> mechanism that fulfills
our need perfectly!</li>
<li><em>numpy-benchmarks</em> tries hard to use randomized input, in order to avoid
over-specialization of a benchmark for a given input set. In some cases this
led to unstable behavior, so we occasionally forced the seed. Changing the
kernel body is not an option; since one of the interests behind using
<em>numpy-benchmarks</em> is that it come from third-party source and
are not tailored for a given compiler.</li>
<li>On very rare occasions, the <em>Pythran</em> annotation language evolves, and
kernels that use new syntax cannot be compiled by older versions of
<em>Pythran</em>. This actually happens only once, now that it is possible to
specify the value dimension of a given dimension. As a workaround, if a
kernel fails to compile, a rewrite rule automatically changes the annotation
back to the traditional, less specialized one.</li>
</ol>
</div>
<div class="section" id="results">
<h2>Results</h2>
<p>As of this post, the result of the regression test is available on
<a class="reference external" href="https://serge-sans-paille.github.io/pythran-asv/">https://serge-sans-paille.github.io/pythran-asv/</a>. It provides a good
illustration of the recent commits :-)</p>
<ul class="simple">
<li><a class="reference external" href="https://serge-sans-paille.github.io/pythran-asv#benchmarks.TimeSuite.time_laplacien">laplacien</a>
greatly benefits from the partially static shape specialization introduced in
<a class="reference external" href="https://github.com/serge-sans-paille/pythran/tree/2e9dc6d694feae2be378fa5351e2cf5ad0c19f1">2e9dc6d69</a>.
This commit also has a positive impact on <a class="reference external" href="https://serge-sans-paille.github.io/pythran-asv#benchmarks.TimeSuite.time_grayscott">grayscott</a>,
but a slightly negative impact on <a class="reference external" href="https://serge-sans-paille.github.io/pythran-asv#benchmarks.TimeSuite.time_wdist">wdist</a>.</li>
<li><a class="reference external" href="https://serge-sans-paille.github.io/pythran-asv#benchmarks.TimeSuite.time_make_decision">make_decision</a> exhibits a pattern captured by
<a class="reference external" href="https://github.com/serge-sans-paille/pythran/tree/a52ee30084549125ef34448f5ccf3013874331a9">a52ee300</a>
: the square of the norm of a complex number.</li>
<li><a class="reference external" href="https://serge-sans-paille.github.io/pythran-asv#benchmarks.TimeSuite.time_reverse_cumsum">reverse_cumsum</a> is returning a complex Numpy view, something Pythran can
efficiently do since <a class="reference external" href="https://github.com/serge-sans-paille/pythran/tree/8e8711365899009634653cc7e11a8cd36001c0c7">8e871136</a>.</li>
</ul>
</div>
<div class="section" id="thanks-and-future-works">
<h2>Thanks and Future Works</h2>
<p>The original idea of using <em>asv</em> to track <em>Pythran</em> performance comes from a
discussion with the <a class="reference external" href="http://quantstack.net/">QuantStack</a> guys. They really
are amazing folks, all the interactions I have with them really keeps the
motivation up. They even funded all this regression tracking stuff for <em>Pythran</em>,
did I mention they're cool?</p>
<p>Next step is probably to run the regression suite on a larger commit range,
this may spot some more regressions or give hint for further improvements. And
I'm pretty confident <a class="reference external" href="https://twitter.com/wuoulf">&#64;wolfv</a> will provide an
adaptation of <em>pythran-asv</em> for <a class="reference external" href="https://github.com/QuantStack/xtensor">xtensor</a> as he <a class="reference external" href="https://twitter.com/wuoulf/status/1016710926047825920">already did</a> for
<em>numpy-benchmarks</em>.</p>
<p>And thanks a lot to <a class="reference external" href="https://ashwinvis.github.io/">ashwinvis</a> for his review!</p>
</div>

                </div><!-- /.entry-content -->
        </article>
</section>
        </div><!--/span-->

                <div class="span3 well sidebar-nav" id="sidebar">
<ul class="nav nav-list">
<li class="nav-header"><h4><i class="icon-external-link"></i>blogroll</h4></li>
    <li><a href="http://pythonhosted.org/pythran"><i class="icon-external-link"></i>Pythran Doc</a></li>
    <li><a href="https://pypi.python.org/pypi/pythran"><i class="icon-external-link"></i>Pythran on PyPI</a></li>
<li class="nav-header"><h4><i class="icon-home icon-large"></i> social</h4></li>
<li><a href="./" rel="alternate"><i class="icon-bookmark icon-large"></i>atom feed</a></li>
    <li><a href="https://github.com/serge-sans-paille/pythran"><i class="icon-github-sign icon-large"></i>github</a></li>

<li class="nav-header"><h4><i class="icon-folder-close icon-large"></i>Categories</h4></li>
<li>
<a href="./category/benchmark.html">
    <i class="icon-folder-open icon-large"></i>benchmark
</a>
</li>
<li>
<a href="./category/compilation.html">
    <i class="icon-folder-open icon-large"></i>compilation
</a>
</li>
<li>
<a href="./category/engineering.html">
    <i class="icon-folder-open icon-large"></i>engineering
</a>
</li>
<li>
<a href="./category/examples.html">
    <i class="icon-folder-open icon-large"></i>examples
</a>
</li>
<li>
<a href="./category/optimisation.html">
    <i class="icon-folder-open icon-large"></i>optimisation
</a>
</li>
<li>
<a href="./category/release.html">
    <i class="icon-folder-open icon-large"></i>release
</a>
</li>

<li class="nav-header"><h4><i class="icon-tags icon-large"></i>Tags</h4></li>


</ul>        </div><!--/.well -->

      </div><!--/row-->

      <hr>

      <footer>
        <address id="about">
                Proudly powered by <a href="http://pelican.notmyidea.org/">Pelican <i class="icon-external-link"></i></a>,
                                which takes great advantage of <a href="http://python.org">Python <i class="icon-external-link"></i></a>.
        </address><!-- /#about -->

        <p>The theme is from <a href="http://twitter.github.com/bootstrap/">Bootstrap from Twitter <i class="icon-external-link"></i></a>,
                   and <a href="http://fortawesome.github.com/Font-Awesome/">Font-Awesome <i class="icon-external-link"></i></a>, thanks!</p>
      </footer>

    </div><!--/.fluid-container-->



    <!-- Le javascript -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="./theme/js/jquery-1.7.2.min.js"></script>
    <script src="./theme/js/bootstrap.min.js"></script>
  </body>
</html>
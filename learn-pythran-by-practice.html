<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Learn Pythran by practice</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="serge-sans-paille and other pythraners">

    <!-- Le styles -->
    <link rel="stylesheet" href="./theme/css/bootstrap.min.css" type="text/css" />
    <style type="text/css">
      body {
        padding-top: 60px;
        padding-bottom: 40px;
      }
      .sidebar-nav {
        padding: 9px 0;
      }
      .tag-1 {
        font-size: 13pt;
      }
      .tag-2 {
        font-size: 10pt;
      }
      .tag-2 {
        font-size: 8pt;
      }
      .tag-4 {
        font-size: 6pt;
     }
    </style>
    <link href="./theme/css/bootstrap-responsive.min.css" rel="stylesheet">
        <link href="./theme/css/font-awesome.css" rel="stylesheet">

    <link href="./theme/css/pygments.css" rel="stylesheet">

    <!-- Le HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="//html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!-- Le fav and touch icons -->
    <link rel="shortcut icon" href="./theme/images/favicon.ico">
    <link rel="apple-touch-icon" href="./theme/images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="./theme/images/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="./theme/images/apple-touch-icon-114x114.png">

    <link href="./" type="application/atom+xml" rel="alternate" title="Pythran stories ATOM Feed" />

  </head>

  <body>

    <div class="navbar navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container-fluid">
          <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </a>
          <a class="brand" href="./index.html">Pythran stories </a>
          <div class="nav-collapse">
            <ul class="nav">
                          <li class="divider-vertical"></li>
                  <li >
                    <a href="./category/benchmark.html">
						<i class="icon-folder-open icon-large"></i>benchmark
					</a>
                  </li>
                  <li >
                    <a href="./category/compilation.html">
						<i class="icon-folder-open icon-large"></i>compilation
					</a>
                  </li>
                  <li >
                    <a href="./category/cython.html">
						<i class="icon-folder-open icon-large"></i>cython
					</a>
                  </li>
                  <li >
                    <a href="./category/engineering.html">
						<i class="icon-folder-open icon-large"></i>engineering
					</a>
                  </li>
                  <li class="active">
                    <a href="./category/examples.html">
						<i class="icon-folder-open icon-large"></i>examples
					</a>
                  </li>
                  <li >
                    <a href="./category/optimisation.html">
						<i class="icon-folder-open icon-large"></i>optimisation
					</a>
                  </li>
                  <li >
                    <a href="./category/release.html">
						<i class="icon-folder-open icon-large"></i>release
					</a>
                  </li>

                          <ul class="nav pull-right">
                                <li><a href="./archives.html"><i class="icon-th-list"></i>Archives</a></li>
                          </ul>

            </ul>
            <!--<p class="navbar-text pull-right">Logged in as <a href="#">username</a></p>-->
          </div><!--/.nav-collapse -->
        </div>
      </div>
    </div>

    <div class="container-fluid">
      <div class="row">
        <div class="span9" id="content">
<section id="content">
        <article>
                <header>
                        <h1>
                                <a href=""
                                        rel="bookmark"
                                        title="Permalink to Learn Pythran by practice">
                                        Learn Pythran by practice
                                </a>
                        </h1>
                </header>
                <div class="entry-content">
                <div class="well">
<footer class="post-info">
<span class="label">Date</span>
<abbr class="published" title="2016-07-04T00:00:00+02:00">
        <i class="icon-calendar"></i>Mon 04 July 2016
</abbr>
<span class="label">By</span>
<a href="./author/pbrunet.html"><i class="icon-user"></i>pbrunet</a>
<span class="label">Category</span>
<a href="./category/examples.html"><i class="icon-folder-open"></i>examples</a>.


</footer><!-- /.post-info -->                </div>
                <p>Pythran presentation hold on Université Lyon1 on Monday 27th June together with a Julia presentation.</p>
<p>You can get slides shown by serge-sans-paille <a href="http://serge-sans-paille.github.io/talks/python-perf-2016-06-27.html">here</a>.</p>
<p>After this presentation, some examples were proposed to see Pythran usage.</p>
<h1>First example: Euler project N°14</h1>
<h2>Problem</h2>
<p>You can find Euler's project problems <a href="https://projecteuler.net/problem=14">here</a>.</p>
<p>The following iterative sequence is defined for the set of positive integers
n -&gt; n/2 (n is even)
n -&gt; 3n + 1 (n is odd)</p>
<p>Using the rule above and starting with 13, we generate the following sequence:
13 -&gt; 40 -&gt; 20 -&gt; 10 -&gt; 5 -&gt; 16 -&gt; 8 -&gt; 4 -&gt; 2 -&gt; 1</p>
<p>It can be seen that this sequence (starting at 13 and fiinishing at 1) contains
10 terms.
Although it has not been proved yet (Collatz Problem), it is thought that all
starting numbers finish at 1.</p>
<p>Which starting number, under one million, produces the longest chain?</p>
<p>NOTE: Once the chain starts the terms are allowed to go above one million.</p>
<h2>Running the script</h2>
<p>We need to get the maximum length of each values.</p>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="k">def</span> <span class="nf">run</span><span class="p">():</span>
<span class="o">...</span>     <span class="n">max_k</span><span class="p">,</span> <span class="n">max_v</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span>
<span class="o">...</span>     <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">1000000</span><span class="p">):</span>
<span class="o">...</span>         <span class="n">new_len</span> <span class="o">=</span> <span class="n">collatz_chain_length</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
<span class="o">...</span>         <span class="k">if</span> <span class="n">new_len</span> <span class="o">&gt;</span> <span class="n">max_v</span><span class="p">:</span>
<span class="o">...</span>             <span class="n">max_k</span><span class="p">,</span> <span class="n">max_v</span> <span class="o">=</span> <span class="n">i</span><span class="p">,</span> <span class="n">new_len</span>
<span class="o">...</span>     <span class="k">return</span> <span class="n">max_k</span>
</pre></div>


<p>Now, we just need to compute the length of the chain for a given value.</p>
<h2>A recursive solution</h2>
<p>Searching on the internet, one can find solutions like <a href="https://www.lucaswillems.com/fr/articles/40/project-euler-14-solution-python">here</a>
or <a href="https://github.com/nayuki/Project-Euler-solutions/blob/master/python/p014.py">here</a></p>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="k">def</span> <span class="nf">collatz_chain_length</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
<span class="o">...</span>     <span class="k">if</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">collatz_cache</span><span class="p">:</span>
<span class="o">...</span>         <span class="k">if</span> <span class="n">x</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<span class="o">...</span>             <span class="n">y</span> <span class="o">=</span> <span class="n">x</span> <span class="o">//</span> <span class="mi">2</span>
<span class="o">...</span>         <span class="k">else</span><span class="p">:</span>
<span class="o">...</span>             <span class="n">y</span> <span class="o">=</span> <span class="n">x</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">+</span> <span class="mi">1</span>
<span class="o">...</span>     <span class="n">collatz_cache</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="n">collatz_chain_length</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
<span class="o">...</span>     <span class="k">return</span> <span class="n">collatz_cache</span><span class="p">[</span><span class="n">x</span><span class="p">]</span>
</pre></div>


<p>This recursive version needs a global variable to cache data as Python is limited by the recursion depth.
As Pythran can't handle non constant globals, we will pass this variable as a second argument</p>
<p>Now time it</p>
<div class="highlight"><pre><span></span>$ python -c <span class="s2">&quot;import prob_14; print prob_14.run()&quot;</span>
<span class="m">837799</span>
$ python -m timeit -s <span class="s2">&quot;import prob_14&quot;</span> <span class="s2">&quot;prob_14.run()&quot;</span>
<span class="m">10</span> loops, best of <span class="m">3</span>: <span class="m">1</span>.26 msec per loop
</pre></div>


<!-- It is 189 msec with the globals variable but I don't understand why it is so fast... -->

<p>OK, this is our reference execution time.</p>
<h2>Imperative solution</h2>
<p>We can perform the direct computation:</p>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="k">def</span> <span class="nf">collatz_chain_length</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
<span class="o">...</span>     <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
<span class="o">...</span>     <span class="k">while</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
<span class="o">...</span>         <span class="k">if</span> <span class="n">x</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<span class="o">...</span>             <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">/</span> <span class="mi">2</span>
<span class="o">...</span>         <span class="k">else</span><span class="p">:</span>
<span class="o">...</span>             <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">+</span> <span class="mi">1</span>
<span class="o">...</span>         <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
<span class="o">...</span>     <span class="k">return</span> <span class="n">count</span>
</pre></div>


<p>Now time it</p>
<div class="highlight"><pre><span></span>$ python -c <span class="s2">&quot;import prob_14; print prob_14.run()&quot;</span>
<span class="m">837799</span>
$ python -m timeit -s <span class="s2">&quot;import prob_14&quot;</span> <span class="s2">&quot;prob_14.run()&quot;</span>
<span class="m">10</span> loops, best of <span class="m">3</span>: <span class="m">12</span>.8 sec per loop
</pre></div>


<p>This solution is slower as it compute everything for each value (no caching mechanism)</p>
<h2>Pythranize the solution</h2>
<p>Look at the imperative solution. We just add in the .py file:</p>
<p><code># pythran export run()</code></p>
<div class="highlight"><pre><span></span>$ python -m pythran.run prob_14.py
$ python -c <span class="s2">&quot;import prob_14; print prob_14.run()&quot;</span>
<span class="m">837799</span>
$ python -m timeit -s <span class="s2">&quot;import prob_14&quot;</span> <span class="s2">&quot;prob_14.run()&quot;</span>
<span class="m">10</span> loops, best of <span class="m">3</span>: <span class="m">626</span> msec per loop
</pre></div>


<p>Result is the same (hopefully...) but it is 20x faster with no effort.
As we use native library, we can go without the <a href="https://wiki.python.org/moin/GlobalInterpreterLock">GIL</a>
and use Pythran OpenMP extension:</p>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="c1"># pythran export run()</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">def</span> <span class="nf">run</span><span class="p">():</span>
<span class="o">...</span>     <span class="n">max_k</span><span class="p">,</span> <span class="n">max_v</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span>
<span class="o">...</span>     <span class="c1"># omp parallel for</span>
<span class="o">...</span>     <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1000000</span><span class="p">):</span>
<span class="o">...</span>         <span class="n">new_len</span> <span class="o">=</span> <span class="n">collatz_chain_length2</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
<span class="o">...</span>         <span class="c1"># omp critical</span>
<span class="o">...</span>         <span class="k">if</span> <span class="n">new_len</span> <span class="o">&gt;</span> <span class="n">max_v</span><span class="p">:</span>
<span class="o">...</span>             <span class="n">max_k</span><span class="p">,</span> <span class="n">max_v</span> <span class="o">=</span> <span class="n">i</span><span class="p">,</span> <span class="n">new_len</span>
<span class="o">...</span>     <span class="k">return</span> <span class="n">max_k</span>
</pre></div>


<div class="highlight"><pre><span></span>$ python -m pythran.run prob_14.py -fopenmp
$ python -c <span class="s2">&quot;import prob_14; print prob_14.run()&quot;</span>
<span class="m">837799</span>
$ python -m timeit -s <span class="s2">&quot;import prob_14&quot;</span> <span class="s2">&quot;prob_14.run()&quot;</span>
<span class="m">10</span> loops, best of <span class="m">3</span>: <span class="m">210</span> msec per loop
</pre></div>


<p>My computer is have 4 CPU and there is another 3x speed up. Which is finally a nice 60x speed up.
It is good but still slower than the recursive function as it doesn't cache values.</p>
<p>Let's look at the recursive solution.</p>
<div class="highlight"><pre><span></span>$ python -m pythran.run prob_14.py
$ python -c <span class="s2">&quot;import prob_14; print prob_14.run()&quot;</span>
<span class="m">837799</span>
$ python -m timeit -s <span class="s2">&quot;import prob_14&quot;</span> <span class="s2">&quot;prob_14.run()&quot;</span>
<span class="m">10</span> loops, best of <span class="m">3</span>: <span class="m">968</span> msec per loop
</pre></div>


<p>We get a 1.3x speed up which is almost nothing. This example show that Python is
not so bad with high level construct like dictionary. As we spend most of the
time looking and hashing data in dictionary, it is already a native code in Python
and we are not really faster with Pythran.</p>
<h2>Conclusion</h2>
<p>If we use high level construct, Python may be the good tool as native code will
not be really faster but if we perform a lot of computation, using Pythran may
be really benefit. Finally, a <em>slow</em> solution with Python may be a <em>fast</em> native
code solution while a <em>fast</em> Python solution may be a <em>slow</em> native code solution.</p>
<h2>Fun fact</h2>
<p>If we add a dummy function:</p>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="c1"># pythran export dummy()</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">def</span> <span class="nf">dummy</span><span class="p">():</span>
<span class="o">...</span>    <span class="k">return</span> <span class="n">run</span><span class="p">()</span>
</pre></div>


<div class="highlight"><pre><span></span>$ python -m pythran.run prob_14.py
$ python -c <span class="s2">&quot;import prob_14; print prob_14.dummy()&quot;</span>
<span class="m">837799</span>
$ python -m timeit -s <span class="s2">&quot;import prob_14&quot;</span> <span class="s2">&quot;prob_14.dummy()&quot;</span>
<span class="m">10000000</span> loops, best of <span class="m">3</span>: <span class="m">0</span>.0415 usec per loop
</pre></div>


<p>This happen because this computation doesn't have any side effect so Pythran
compute the result at compile time and <code>dummy()</code> only give the pre-computed result.</p>
<h1>Second example: rbf network</h1>
<p>This code is extracted from <a href="http://nealhughes.net/cython1/">here</a>.</p>
<p>Example function evaluates a Radial Basis Function (RBF) approximation scheme.</p>
<p>So that everybody works with the same kind of data, we will setup env with:</p>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">D</span> <span class="o">=</span> <span class="mi">5</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">N</span> <span class="o">=</span> <span class="mi">1000</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">D</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">)])</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">beta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">theta</span> <span class="o">=</span> <span class="mi">10</span>
</pre></div>


<p>Original code is:</p>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="k">def</span> <span class="nf">rbf_network</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">theta</span><span class="p">):</span>
<span class="o">...</span> 
<span class="o">...</span>     <span class="n">N</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="o">...</span>     <span class="n">D</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="o">...</span>     <span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
<span class="o">...</span> 
<span class="o">...</span>     <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
<span class="o">...</span>         <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
<span class="o">...</span>             <span class="n">r</span> <span class="o">=</span> <span class="mi">0</span>
<span class="o">...</span>             <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">D</span><span class="p">):</span>
<span class="o">...</span>                 <span class="n">r</span> <span class="o">+=</span> <span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">d</span><span class="p">]</span> <span class="o">-</span> <span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">d</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span>
<span class="o">...</span>             <span class="n">r</span> <span class="o">=</span> <span class="n">r</span><span class="o">**</span><span class="mf">0.5</span>
<span class="o">...</span>             <span class="n">Y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">beta</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">r</span> <span class="o">*</span> <span class="n">theta</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
<span class="o">...</span> 
<span class="o">...</span>     <span class="k">return</span> <span class="n">Y</span>
</pre></div>


<p>First, we time the original solution.</p>
<div class="highlight"><pre><span></span>$ python -m timeit -s <span class="s2">&quot;import numpy as np;D = 5;N = 1000;X = np.array([np.random.rand(D) for d in range(N)]);beta = np.random.rand(N);theta = 10;import origin&quot;</span> <span class="s2">&quot;origin.rbf_network(X, beta, theta)&quot;</span>
<span class="m">10</span> loops, best of <span class="m">3</span>: <span class="m">4</span>.09 sec per loop
</pre></div>


<h2>Turn Python kernel to Numpy kernel</h2>
<p>Numpy mostly run as native code. Using its broadcasting feature permit to use more native code and thus, run it faster.</p>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="k">def</span> <span class="nf">rbf_network_numpy</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">theta</span><span class="p">):</span>
<span class="o">...</span>     <span class="k">return</span> <span class="p">(</span><span class="n">beta</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(((</span><span class="n">X</span><span class="p">[:,</span> <span class="bp">None</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">X</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="o">*</span> <span class="n">theta</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</pre></div>


<p>With this pure Numpy code, we first check result:</p>
<div class="highlight"><pre><span></span>$ python -c <span class="s2">&quot;import numpy as np;D = 5;N = 1000;X = np.array([np.random.rand(D) for d in range(N)]);beta = np.random.rand(N);theta = 10;import origin; print np.allclose(origin.rbf_network_numpy(X, beta, theta), origin.rbf_network(X, beta, theta))&quot;</span>
True
</pre></div>


<p>Then, we can time it:</p>
<div class="highlight"><pre><span></span>$ python -m timeit -s <span class="s2">&quot;import numpy as np;D = 5;N = 1000;X = np.array([np.random.rand(D) for d in range(N)]);beta = np.random.rand(N);theta = 10;import origin&quot;</span> <span class="s2">&quot;origin.rbf_network_numpy(X, beta, theta)&quot;</span>
<span class="m">10</span> loops, best of <span class="m">3</span>: <span class="m">73</span>.6 msec per loop
</pre></div>


<p>and it is 55x faster.</p>
<p>This speed can be enough for our case then, we can use only Python code and everything is fine.
We can also use Pythran to make it even faster.</p>
<h2>Use Pythran on rbf network</h2>
<p>Once again, we just add the pythran comment:
<code># pythran rbf_network(float[][], float[], float)</code></p>
<p>We check the result</p>
<div class="highlight"><pre><span></span>$ python -c <span class="s2">&quot;import numpy as np;D = 5;N = 1000;X = np.array([np.random.rand(D) for d in range(N)]);beta = np.random.rand(N);theta = 10;import origin;import origin_python;print np.allclose(origin.rbf_network_numpy(X, beta, theta), origin_python.rbf_network(X, beta, theta))&quot;</span>
True
</pre></div>


<p>And we time it</p>
<div class="highlight"><pre><span></span>$ python -m timeit -s <span class="s2">&quot;import numpy as np;D = 5;N = 1000;X = np.array([np.random.rand(D) for d in range(N)]);beta = np.random.rand(N);theta = 10;import origin&quot;</span> <span class="s2">&quot;origin.rbf_network_numpy(X, beta, theta)&quot;</span>
<span class="m">10</span> loops, best of <span class="m">3</span>: <span class="m">67</span>.4 msec per loop
</pre></div>


<p>It is already slightly faster than Numpy.</p>
<p>To be even faster, we generate beta version to vectorize code:</p>
<div class="highlight"><pre><span></span>$ python -m pythran.run origin.py -Ofast -march<span class="o">=</span>native -DUSE_BOOST_SIMD
$ python -m timeit -s <span class="s2">&quot;import numpy as np;D = 5;N = 1000;X = np.array([np.random.rand(D) for d in range(N)]);beta = np.random.rand(N);theta = 10;import origin&quot;</span> <span class="s2">&quot;origin.rbf_network_numpy(X, beta, theta)&quot;</span>
<span class="m">10</span> loops, best of <span class="m">3</span>: <span class="m">26</span>.1 msec per loop
</pre></div>


<h2>Scipy.rbf</h2>
<p>Scipy also provide rbf function but if we time it, we have:</p>
<div class="highlight"><pre><span></span>$ python -m timeit -s <span class="s2">&quot;import numpy as np;D = 5;N = 1000;X = np.array([np.random.rand(D) for d in range(N)]);beta = np.random.rand(N);theta = 10;from scipy.interpolate import Rbf;rbf = Rbf(X[:,0], X[:,1], X[:,2], X[:,3], X[:, 4], beta);Xtuple = tuple([X[:, i] for i in range(D)]);&quot;</span> <span class="s2">&quot;rbf(Xtuple)&quot;</span>
<span class="m">10</span> loops, best of <span class="m">3</span>: <span class="m">258</span> msec per loop
</pre></div>


<p>Which is slower than Numpy version. Certainly because this function is much more generic than our.</p>
<h2>Conclusion</h2>
<p>Pure Numpy kernel is almost as fast as native kernel and we should not bother with accelerator
if we don't need more performances. If we need more, Pythran can give a 3x speed up on it mainly because it can generate SIMD code thanks to Boost.SIMD</p>
<h1>Third (and last) example: mandelbrot</h1>
<p>Most of the time, our Python code use more than modules provided by Pythran but we still need performance.</p>
<p>Here is an example from <a href="http://rosettacode.org/">rosetacode</a></p>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">pylab</span> <span class="kn">import</span> <span class="o">*</span>
<span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">numpy</span> <span class="kn">import</span> <span class="n">NaN</span>

<span class="o">&gt;&gt;&gt;</span> <span class="k">def</span> <span class="nf">m</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
<span class="o">...</span>     <span class="n">z</span> <span class="o">=</span> <span class="mi">0</span>
<span class="o">...</span>     <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">100</span><span class="p">):</span>
<span class="o">...</span>         <span class="n">z</span> <span class="o">=</span> <span class="n">z</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">a</span>
<span class="o">...</span>         <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">z</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
<span class="o">...</span>             <span class="k">return</span> <span class="n">n</span>
<span class="o">...</span>     <span class="k">return</span> <span class="n">NaN</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">X</span> <span class="o">=</span> <span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">.</span><span class="mi">5</span><span class="p">,</span> <span class="o">.</span><span class="mo">002</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">Y</span> <span class="o">=</span> <span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span> <span class="o">.</span><span class="mo">002</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">Z</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">Y</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)))</span>

<span class="o">&gt;&gt;&gt;</span> <span class="k">for</span> <span class="n">iy</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">Y</span><span class="p">):</span>
<span class="o">...</span>     <span class="k">print</span> <span class="p">(</span><span class="n">iy</span><span class="p">,</span> <span class="s2">&quot;of&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">Y</span><span class="p">))</span>
<span class="o">...</span>     <span class="k">for</span> <span class="n">ix</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">X</span><span class="p">):</span>
<span class="o">...</span>         <span class="n">Z</span><span class="p">[</span><span class="n">iy</span><span class="p">,</span><span class="n">ix</span><span class="p">]</span> <span class="o">=</span> <span class="n">m</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="mi">1j</span> <span class="o">*</span> <span class="n">y</span><span class="p">)</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">imshow</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span> <span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">prism</span><span class="p">,</span> <span class="n">interpolation</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">extent</span> <span class="o">=</span> <span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">X</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">Y</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">Y</span><span class="o">.</span><span class="n">max</span><span class="p">()))</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Re(c)&quot;</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Im(c)&quot;</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">savefig</span><span class="p">(</span><span class="s2">&quot;mandelbrot_python.svg&quot;</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">show</span><span class="p">()</span>
</pre></div>


<p>As Pythran doesn't handle graphics modules like pylab, we need to separate computation intensive part and
graphics code.</p>
<p><code>my_module.py</code></p>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>

<span class="o">&gt;&gt;&gt;</span> <span class="k">def</span> <span class="nf">m</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
<span class="o">...</span>     <span class="n">z</span> <span class="o">=</span> <span class="mi">0</span>
<span class="o">...</span>     <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">100</span><span class="p">):</span>
<span class="o">...</span>         <span class="n">z</span> <span class="o">=</span> <span class="n">z</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">a</span>
<span class="o">...</span>         <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">z</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
<span class="o">...</span>             <span class="k">return</span> <span class="n">n</span>
<span class="o">...</span>     <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span>

<span class="o">&gt;&gt;&gt;</span> <span class="k">def</span> <span class="nf">mandel</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">):</span>
<span class="o">...</span>     <span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">Y</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)))</span>
<span class="o">...</span> 
<span class="o">...</span>     <span class="k">for</span> <span class="n">iy</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">Y</span><span class="p">):</span>
<span class="o">...</span>         <span class="k">for</span> <span class="n">ix</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">X</span><span class="p">):</span>
<span class="o">...</span>             <span class="n">Z</span><span class="p">[</span><span class="n">iy</span><span class="p">,</span><span class="n">ix</span><span class="p">]</span> <span class="o">=</span> <span class="n">m</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="mi">1j</span> <span class="o">*</span> <span class="n">y</span><span class="p">)</span>
<span class="o">...</span>     <span class="k">return</span> <span class="n">Z</span>
</pre></div>


<p><code>script.py</code></p>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">pylab</span> <span class="kn">import</span> <span class="o">*</span>
<span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">my_module</span> <span class="kn">import</span> <span class="n">mandel</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">X</span> <span class="o">=</span> <span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">.</span><span class="mi">5</span><span class="p">,</span> <span class="o">.</span><span class="mo">002</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">Y</span> <span class="o">=</span> <span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span> <span class="o">.</span><span class="mo">002</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">Z</span> <span class="o">=</span> <span class="n">mandel</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">)</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">imshow</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span> <span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">prism</span><span class="p">,</span> <span class="n">interpolation</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">extent</span> <span class="o">=</span> <span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">X</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">Y</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">Y</span><span class="o">.</span><span class="n">max</span><span class="p">()))</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Re(c)&quot;</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Im(c)&quot;</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">savefig</span><span class="p">(</span><span class="s2">&quot;mandelbrot_python.svg&quot;</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">show</span><span class="p">()</span>
</pre></div>


<p>Now, we can time and improve the mandel function.</p>
<div class="highlight"><pre><span></span>$ <span class="nb">time</span> python -c <span class="s2">&quot;import numpy as np;X = np.arange(-2, .5, .002);Y = np.arange(-1,  1, .002); import my_module; my_module.mandel(X, Y)&quot;</span>

real    0m19.495s
user    0m19.476s
sys 0m0.016s
</pre></div>


<p>I use time here as I want a one show as it is a really long run.</p>
<p>After using Pythran on it, we have:</p>
<div class="highlight"><pre><span></span>$ python -m pythran.run my_module.py
$ python -m timeit -s <span class="s2">&quot;import numpy as np;X = np.arange(-2, .5, .002);Y = np.arange(-1,  1, .002); import my_module&quot;</span> <span class="s2">&quot;my_module.mandel(X, Y)&quot;</span>
<span class="m">10</span> loops, best of <span class="m">3</span>: <span class="m">538</span> msec per loop
</pre></div>


<p>It is 40 times faster and graphics part are still possible through Python.</p>
<p>There is no need to try with SIMD as it doesn't work on complex numbers.</p>
<h1>Conclusion</h1>
<p>I hope these examples show what performance can be reach using Python/Numpy and
when you need to use an accelerator to generate faster native code.</p>
                </div><!-- /.entry-content -->
        </article>
</section>
        </div><!--/span-->

                <div class="span3 well sidebar-nav" id="sidebar">
<ul class="nav nav-list">
<li class="nav-header"><h4><i class="icon-external-link"></i>blogroll</h4></li>
    <li><a href="https://pythran.readthedocs.io"><i class="icon-external-link"></i>Pythran Doc</a></li>
    <li><a href="https://pypi.python.org/pypi/pythran"><i class="icon-external-link"></i>Pythran on PyPI</a></li>
<li class="nav-header"><h4><i class="icon-home icon-large"></i> social</h4></li>
<li><a href="./feeds/all.atom.xml" rel="alternate"><i class="icon-bookmark icon-large"></i>atom feed</a></li>
    <li><a href="https://github.com/serge-sans-paille/pythran"><i class="icon-github-sign icon-large"></i>github</a></li>

<li class="nav-header"><h4><i class="icon-folder-close icon-large"></i>Categories</h4></li>
<li>
<a href="./category/benchmark.html">
    <i class="icon-folder-open icon-large"></i>benchmark
</a>
</li>
<li>
<a href="./category/compilation.html">
    <i class="icon-folder-open icon-large"></i>compilation
</a>
</li>
<li>
<a href="./category/cython.html">
    <i class="icon-folder-open icon-large"></i>cython
</a>
</li>
<li>
<a href="./category/engineering.html">
    <i class="icon-folder-open icon-large"></i>engineering
</a>
</li>
<li>
<a href="./category/examples.html">
    <i class="icon-folder-open icon-large"></i>examples
</a>
</li>
<li>
<a href="./category/optimisation.html">
    <i class="icon-folder-open icon-large"></i>optimisation
</a>
</li>
<li>
<a href="./category/release.html">
    <i class="icon-folder-open icon-large"></i>release
</a>
</li>

<li class="nav-header"><h4><i class="icon-tags icon-large"></i>Tags</h4></li>


</ul>        </div><!--/.well -->

      </div><!--/row-->

      <hr>

      <footer>
        <address id="about">
                Proudly powered by <a href="http://pelican.notmyidea.org/">Pelican <i class="icon-external-link"></i></a>,
                                which takes great advantage of <a href="http://python.org">Python <i class="icon-external-link"></i></a>.
        </address><!-- /#about -->

        <p>The theme is from <a href="http://twitter.github.com/bootstrap/">Bootstrap from Twitter <i class="icon-external-link"></i></a>,
                   and <a href="http://fortawesome.github.com/Font-Awesome/">Font-Awesome <i class="icon-external-link"></i></a>, thanks!</p>
      </footer>

    </div><!--/.fluid-container-->



    <!-- Le javascript -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="./theme/js/jquery-1.7.2.min.js"></script>
    <script src="./theme/js/bootstrap.min.js"></script>
  </body>
</html>